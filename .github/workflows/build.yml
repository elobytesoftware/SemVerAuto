name: Build

on:
  workflow_run:
    workflows: ["Release and Secrets"]
    types:
      - completed
jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Set Up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.18.0'

    - name: Determine Environment
      id: set-environment
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "ENVIRONMENT=dev" >> $GITHUB_ENV
        elif [[ "${{ github.ref }}" == refs/heads/releases/qa* ]]; then
          echo "ENVIRONMENT=qa" >> $GITHUB_ENV
        elif [[ "${{ github.ref }}" == refs/heads/releases/prod* ]]; then
          echo "ENVIRONMENT=prod" >> $GITHUB_ENV
        fi

    - name: Log in to Docker Hub
      run: echo ${{ env.DOCKER_PASSWORD }} | docker login -u ${{ env.DOCKER_USERNAME }} --password-stdin

    - name: Build and Tag Docker Image
      run: docker build -t ${{ env.DOCKER_IMAGE_URL }}:${{ env.ENVIRONMENT }} .

    - name: Push Docker Image
      run: docker push ${{ env.DOCKER_IMAGE_URL }}:${{ env.ENVIRONMENT }}
